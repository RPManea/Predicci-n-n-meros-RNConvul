<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Red Neuronal numeros</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    canvas {
        border: 1px solid black;
        margin-bottom: 10px;
    }
    .resultado {
        font-weight: bold;
        font-size: 20px;
    }
</style>
</head>
<body class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">

<div class="container text-center">
    <div class="titulo">
        <h1>Predicción números escritos a mano</h1>
    </div>
    <div class="row">
        <div class="col">
            <canvas id="canvas" width="280" height="280" style="width: 100%; max-width: 280px;"></canvas>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <button type="button" class="btn btn-primary mr-2" onclick="predictNumber()">Predecir Número</button>
            <button type="button" class="btn btn-secondary" onclick="clearCanvas()">Limpiar</button>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <table class="table">
                <thead>
                    <tr>
                        <th>Modo 1 (Denso)</th>
                        <th>Modo 2 (Conv)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><div id="prediction" class="resultado"></div></td>
                        <td><div id="predictionV2" class="resultado"></div></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.8.0"></script>
<script>
    // Cargar el modelo original
    async function loadModel() {
        const model = await tf.loadLayersModel('model.json');
        return model;
    }

    // Cargar el modelo v2
    async function loadModelV2() {
        const model = await tf.loadLayersModel('modelv2.json');
        return model;
    }

    // Predecir el número dibujado en el lienzo
    async function predictNumber() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Escalar la imagen del lienzo a 28x28 píxeles
        const scaledImage = ctx.getImageData(0, 0, 280, 280);
        const scaledCanvas = document.createElement('canvas');
        const scaledCtx = scaledCanvas.getContext('2d');
        scaledCanvas.width = 28;
        scaledCanvas.height = 28;
        scaledCtx.drawImage(canvas, 0, 0, 28, 28);

        // Obtener los datos de píxeles de la imagen escalada
        const imageData = scaledCtx.getImageData(0, 0, 28, 28);
        const pixels = imageData.data;

        // Convertir los datos de píxeles en un tensor
        let input = [];
        for (let i = 0; i < pixels.length; i += 4) {
            input.push(pixels[i + 3] / 255); // Escalar a valores entre 0 y 1
        }
        input = tf.tensor(input).reshape([1, 28, 28, 1]);

        // Cargar el modelo original
        const model = await loadModel();
        // Realizar la predicción con el modelo original
        const prediction = model.predict(input);
        // Obtener el índice de la clase con la mayor probabilidad
        const predictedClass = prediction.argMax(1).dataSync()[0];
        document.getElementById('prediction').innerText = predictedClass;

        // Cargar el modelo v2
        const modelV2 = await loadModelV2();
        // Realizar la predicción con el modelo v2
        const predictionV2 = modelV2.predict(input);
        // Obtener el índice de la clase con la mayor probabilidad para el modelo v2
        const predictedClassV2 = predictionV2.argMax(1).dataSync()[0];
        document.getElementById('predictionV2').innerText = predictedClassV2;
    }

    // Limpiar el lienzo
    function clearCanvas() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('prediction').innerText = '';
        document.getElementById('predictionV2').innerText = '';
    }

    // Inicializar el lienzo para dibujar
    function initCanvas() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            draw(e.clientX, e.clientY, false);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                draw(e.clientX, e.clientY, true);
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        function draw(x, y, isDrawing) {
            const rect = canvas.getBoundingClientRect(); // Obtener la posición del lienzo en la ventana

            // Calcular las coordenadas relativas al lienzo centrado
            const offsetX = rect.left + window.scrollX;
            const offsetY = rect.top + window.scrollY;

            if (!isDrawing) {
                ctx.beginPath();
                ctx.moveTo(x - offsetX, y - offsetY); // Ajustar las coordenadas
            } else {
                ctx.lineTo(x - offsetX, y - offsetY); // Ajustar las coordenadas
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 20; // Aumentar el tamaño del trazo
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }
        }
    }

    // Ejecutar la función de inicialización del lienzo cuando la página se cargue
    window.onload = function() {
        initCanvas();
    };
</script>

</body>
</html>
